<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Breast Tumor Detection</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='Upload.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='Navbar.css') }}">
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-logo" style="cursor:pointer;" onclick="window.location.href='/'">
      <span class="logo-icon">ğŸ—ï¸</span> BreastCare
    </div>
    <ul class="navbar-links">
      <li><a href="/home">Home</a></li>
      <li><a href="/features">Features</a></li>
      <li><a href="/contact">Contact</a></li>
      <li><a href="/login">Login/SignUp</a></li>
    </ul>
  </nav>

  <!-- Upload Section -->
  <div class="pest-container">
    <div class="pest-card">
      <h2 class="pest-title">IDENTIFY WHETHER BREAST CANCER IS DETECTED OR NOT</h2>
      <p class="pest-subtitle">Upload a breast ultrasound image.</p>

      <label class="custom-file-upload">
        <input type="file" id="fileInput" accept="image/*" />
        Choose File
      </label>
      <span id="fileName" class="file-name"></span>

      <div id="imagePreview" class="image-preview" style="display: none;">
        <img id="previewImg" alt="Preview" />
      </div>

      <button class="predict-btn" id="predictBtn">Predict</button>
      <p id="result" class="prediction-result"></p>

      <button id="viewDetailsBtn" class="predict-btn" style="display:none; background-color:#2e7d32;">
        View Tumor Region
      </button>
    </div>
  </div>

  <script>
    const BACKEND_URL = "/predict";
    let selectedFile = null;

    const fileInput = document.getElementById("fileInput");
    const fileName = document.getElementById("fileName");
    const imagePreview = document.getElementById("imagePreview");
    const previewImg = document.getElementById("previewImg");
    const predictBtn = document.getElementById("predictBtn");
    const resultText = document.getElementById("result");
    const viewDetailsBtn = document.getElementById("viewDetailsBtn");

    // --- Preview selected file ---
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        selectedFile = file;
        fileName.textContent = file.name;
        previewImg.src = URL.createObjectURL(file);
        imagePreview.style.display = "block";
        resultText.innerText = "";
        viewDetailsBtn.style.display = "none";
      }
    });

    // --- Predict button handler ---
    predictBtn.addEventListener("click", async () => {
      if (!selectedFile) {
        alert("Please upload an image first!");
        return;
      }

      resultText.style.color = "#000";
      resultText.innerText = "ğŸ” Analyzing... Please wait.";

      const formData = new FormData();
      formData.append("image", selectedFile);

      try {
        const res = await fetch(BACKEND_URL, { method: "POST", body: formData });
        const data = await res.json();

        // Handle invalid image case (non-ultrasound)
        if (res.status === 400 && data.prediction === "Invalid Image") {
          alert("âš ï¸ Invalid image! Please upload a valid breast ultrasound image.");
          resultText.style.color = "orange";
          resultText.innerHTML = `<b>âŒ Rejected:</b> ${data.description}<br><i>${data.recommendation}</i>`;
          viewDetailsBtn.style.display = "none";
          return;
        }

        // Handle other backend errors
        if (data.error) {
          resultText.style.color = "red";
          resultText.innerText = "âŒ Error: " + data.error;
          return;
        }

        // Prediction color logic
        if (data.prediction.includes("Normal")) resultText.style.color = "green";
        else if (data.prediction.includes("Tumor")) resultText.style.color = "red";
        else resultText.style.color = "#000";

        // Display formatted result
        resultText.innerHTML = `
          <b>ğŸ§  Prediction:</b> ${data.prediction}<br>
          ğŸ“Š ${data.description}<br>
          ğŸ’¡ <b>Recommendation:</b> ${data.recommendation}
        `;

        // Show overlay (only if tumor found)
        if (data.is_tumor && data.overlay_image) {
          sessionStorage.setItem("overlay_image", data.overlay_image);
          viewDetailsBtn.style.display = "inline-block";
        } else {
          viewDetailsBtn.style.display = "none";
        }

      } catch (error) {
        console.error(error);
        resultText.style.color = "red";
        resultText.innerText = "âŒ Failed to connect to the server.";
      }
    });

    // --- View details page ---
    viewDetailsBtn.addEventListener("click", () => {
      window.open("/details", "_blank");
    });
  </script>

  <footer class="footer">
    <p>Â© 2025 BreastCare â€” AI-powered Breast Cancer Detection System</p>
  </footer>
</body>
</html>
